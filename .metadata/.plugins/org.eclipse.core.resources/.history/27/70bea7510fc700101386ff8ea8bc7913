package com.loyalty.services;

import com.loyalty.dtos.DashboardInfoDTO;
import com.loyalty.dtos.RecentActivityDTO;
import com.loyalty.dtos.RewardConfigDTO;
import com.loyalty.models.Business;
import com.loyalty.models.LoyaltyLog;
import com.loyalty.models.User;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class BusinessDashboardService {

    private final RewardConfigService rewardConfigService;

    public DashboardInfoDTO getDashboardInfo(Business business) {

        // Lista de usuarios pertenecientes al negocio
        List<User> clientes = business.getClientes(); // Debe existir este método en Business

        long totalUsers = clientes.size();

        // Calcular puntos totales asignados y canjeados
        long totalEarned = clientes.stream()
                .flatMap(u -> u.getLoyaltyLogs().stream()) // Debe existir getLoyaltyLogs en User
                .filter(log -> "ASIGNACION".equalsIgnoreCase(log.getTipo()))
                .mapToLong(LoyaltyLog::getCantidad)
                .sum();

        long totalRedeemed = clientes.stream()
                .flatMap(u -> u.getLoyaltyLogs().stream())
                .filter(log -> "CANJE".equalsIgnoreCase(log.getTipo()))
                .mapToLong(LoyaltyLog::getCantidad)
                .sum();

        // Actividades recientes: últimos 10 movimientos
        List<RecentActivityDTO> recentActivities = clientes.stream()
                .flatMap(u -> u.getLoyaltyLogs().stream())
                .sorted(Comparator.comparing(LoyaltyLog::getFecha).reversed())
                .limit(10)
                .map(RecentActivityDTO::fromLoyaltyLog)
                .collect(Collectors.toList());

        // Configuración de recompensas del negocio
        RewardConfigDTO rewardConfig = rewardConfigService.getConfig(business.getId());

        return DashboardInfoDTO.builder()
                .businessName(business.getNombre())
                .totalUsers(totalUsers)
                .totalPointsEarned(totalEarned)
                .totalPointsRedeemed(totalRedeemed)
                .recentActivities(recentActivities)
                .rewardConfig(rewardConfig)
                .build();
    }
}